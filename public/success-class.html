<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orbit Sidebar</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body: #050505;
      --bg-surface: #111111;
      --bg-chat-bubble: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #888888;
      --status-live: #EB5757; 
      --status-active: #27AE60;
      --accent: #fff;
      --font: "Inter", -apple-system, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* === UTILITY MODAL === */
    .modal-overlay {
      position: fixed; inset: 0;
      background: #000;
      z-index: 9999;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .modal-overlay.hidden { opacity: 0; pointer-events: none; }
    
    .modal-card {
      width: 100%; max-width: 320px;
      padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
    }

    .modal-header { font-size: 14px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: #666; margin-bottom: 8px; }

    /* Modal Tabs */
    .mode-tabs { display: flex; background: #1a1a1a; padding: 4px; border-radius: 8px; margin-bottom: 12px; }
    .mode-tab { 
      flex: 1; border: none; background: transparent; color: #666; 
      padding: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: 0.2s; 
    }
    .mode-tab.active { background: #333; color: white; }

    .modal-input {
      width: 100%; padding: 12px;
      background: #111; border: 1px solid #333; color: white;
      border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s;
    }
    .modal-input:focus { border-color: #666; }
    
    .btn-action {
      width: 100%; padding: 14px;
      background: white; color: black;
      border: none; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      margin-top: 8px;
    }
    .btn-action:active { transform: scale(0.98); }

    /* === MAIN APP === */
    .app-container {
      width: 100%; max-width: 500px; height: 100%;
      display: flex; flex-direction: column;
      position: relative;
      background: var(--bg-body);
    }

    @media (min-width: 501px) {
      .app-container { height: 95vh; border-radius: 16px; border: 1px solid #222; background: var(--bg-surface); overflow: hidden; }
    }

    /* === HEADER & SHARE ICONS === */
    .header {
      padding: 12px 16px; z-index: 20;
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(17,17,17,0.9);
      border-bottom: 1px solid #222;
      position: relative;
    }
    
    .room-info { display: flex; flex-direction: column; }
    .room-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
    .room-id { font-family: monospace; font-size: 16px; font-weight: 600; color: white; letter-spacing: 1px;}
    
    /* Share Actions Row */
    .share-row { display: flex; gap: 6px; align-items: center; }
    
    .share-btn {
      width: 28px; height: 28px; border-radius: 6px; border: none;
      background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s ease; position: relative;
    }
    .share-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
    .share-btn:active { transform: scale(0.95); }
    
    .share-icon { width: 14px; height: 14px; fill: #aaa; transition: fill 0.2s; }
    
    /* Hover Colors */
    .btn-copy:hover .share-icon { fill: #fff; }
    .btn-wa:hover .share-icon { fill: #25D366; }
    .btn-sms:hover .share-icon { fill: #34B7F1; }
    .btn-mail:hover .share-icon { fill: #EA4335; }
    .btn-fb:hover .share-icon { fill: #0084FF; }

    /* Raise Hand Notification */
    .raise-hand-notification {
      position: absolute; top: 100%; left: 0; right: 0;
      background: rgba(0, 0, 0, 0.9); padding: 8px 16px;
      font-size: 16px; color: limegreen; font-weight: 600;
      display: none; align-items: center; gap: 8px;
      border-bottom: 1px solid #333;
      animation: slideDown 0.3s ease;
      justify-content: flex-start;
    }
    .raise-hand-notification.show { display: flex; }
    .raise-hand-notification .hand-icon { font-size: 18px; }
    .raise-hand-notification .close-btn {
      margin-left: auto; background: none; border: none;
      color: #888; cursor: pointer; padding: 4px;
      font-size: 14px; line-height: 1; transition: color 0.2s;
    }
    .raise-hand-notification .close-btn:hover { color: white; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Raise Hand Button */
    .raise-hand-btn {
      display: flex; align-items: center; justify-content: center;
      width: 44px; height: 44px; border-radius: 50%;
      background: linear-gradient(145deg, #1a1a1a, #111);
      border: 1px solid #333; color: white;
      cursor: pointer; transition: all 0.3s ease;
      font-size: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .raise-hand-btn:hover { 
      background: linear-gradient(145deg, #252525, #1a1a1a);
      transform: translateY(-2px); 
    }
    .raise-hand-btn:active { transform: translateY(0); }
    .raise-hand-btn.raised {
      background: linear-gradient(145deg, #f9a825, #f57f17);
      border-color: #ffca28;
      animation: handWave 0.5s ease;
    }
    @keyframes handWave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); } }

    /* === SETTINGS BAR === */
    .settings-bar {
      padding: 10px 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
      border-bottom: 1px solid #222; background: var(--bg-surface);
    }
    .setting-group label { display: block; font-size: 9px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
    select {
      width: 100%; background: transparent; color: white; border: none;
      font-size: 12px; font-family: var(--font); cursor: pointer;
      border-bottom: 1px solid #333; padding-bottom: 4px;
    }
    select option { background: #111; color: white; }

    /* === TRANSCRIPT AREA === */
    .chat-area {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%);
      mask-image: linear-gradient(to bottom, transparent 0%, black 5%);
    }

    .msg-item { animation: slideIn 0.3s ease; display: flex; flex-direction: column; gap: 4px; }
    .msg-meta { font-size: 10px; color: var(--text-secondary); display: flex; justify-content: space-between; padding: 0 2px;}
    .msg-name { font-weight: 600; color: #fff; }
    
    .msg-bubble {
      background: var(--bg-chat-bubble); padding: 10px 14px; border-radius: 4px 14px 14px 14px;
      font-size: 18px; line-height: 1.4; color: limegreen; border: 1px solid #2a2a2a;
    }
    
    .msg-item.me { align-items: flex-end; opacity: 0.8; }
    .msg-item.me .msg-bubble { background: #222; border-radius: 14px 4px 14px 14px; border-color: #333; text-align: right; font-size: 18px; color: #eee; }

    /* === FOOTER CONTROLS === */
    .footer {
      padding: 20px 16px; background: linear-gradient(to top, var(--bg-body) 40%, transparent);
      display: flex; flex-direction: column; align-items: center; gap: 16px;
    }

    .controls-row { 
      display: flex; align-items: center; gap: 12px; width: 100%; 
      justify-content: center; flex-wrap: nowrap;
    }

    /* Modern Control Button Base */
    .control-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; border-radius: 50px;
      background: linear-gradient(145deg, #1a1a1a, #111);
      border: 1px solid #333; color: white;
      cursor: pointer; transition: all 0.3s ease;
      font-family: var(--font); font-size: 12px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
      position: relative; overflow: hidden;
      flex: 1; max-width: 160px; justify-content: center;
    }
    .control-btn:hover { 
      background: linear-gradient(145deg, #252525, #1a1a1a);
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .control-btn:active { transform: translateY(0); }

    /* Mic Button Active State */
    .control-btn.mic-active {
      background: linear-gradient(145deg, #d32f2f, #b71c1c);
      border-color: #ef5350;
      box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .control-btn.mic-active:hover {
      background: linear-gradient(145deg, #e53935, #c62828);
    }

    /* Speaker Button Active State */
    .control-btn.speaker-active {
      background: linear-gradient(145deg, #2e7d32, #1b5e20);
      border-color: #66bb6a;
      box-shadow: 0 4px 20px rgba(46, 125, 50, 0.4), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .control-btn.speaker-active:hover {
      background: linear-gradient(145deg, #388e3c, #2e7d32);
    }

    /* Button Icon */
    .control-btn-icon {
      width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
    }
    .control-btn-icon svg {
      width: 100%; height: 100%;
      stroke: currentColor; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }

    /* Inline Visualizer */
    .btn-visualizer {
      display: flex; align-items: center; gap: 2px;
      height: 20px; min-width: 30px;
    }
    .viz-bar {
      width: 3px; background: currentColor; border-radius: 2px;
      opacity: 0.6; transition: height 0.1s ease;
      height: 4px;
    }
    .control-btn.mic-active .viz-bar,
    .control-btn.speaker-active .viz-bar {
      animation: vizPulse 0.4s ease-in-out infinite alternate;
    }
    .viz-bar:nth-child(1) { animation-delay: 0s; }
    .viz-bar:nth-child(2) { animation-delay: 0.1s; }
    .viz-bar:nth-child(3) { animation-delay: 0.05s; }
    .viz-bar:nth-child(4) { animation-delay: 0.15s; }
    .viz-bar:nth-child(5) { animation-delay: 0.08s; }

    @keyframes vizPulse {
      0% { height: 4px; opacity: 0.4; }
      100% { height: 18px; opacity: 1; }
    }

    /* Status Indicator */
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #666; transition: all 0.3s;
    }
    .control-btn.mic-active .status-dot { 
      background: #fff; 
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
      animation: pulse 1s ease-in-out infinite;
    }
    .control-btn.speaker-active .status-dot { 
      background: #fff; 
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .toast {
      position: absolute; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: white; color: black; padding: 6px 16px; border-radius: 20px;
      font-size: 11px; font-weight: 700; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .hidden { display: none !important; }

  </style>
</head>

<body>

<!-- 1. COMPACT UTILITY MODAL -->
<div id="welcomeModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">Session Setup</div>
    
    <!-- Always need name -->
    <input type="text" id="usernameInput" class="modal-input" placeholder="Your Name" maxlength="15">

    <!-- Mode Switcher -->
    <div class="mode-tabs">
      <button class="mode-tab active" id="tabCreate">Create</button>
      <button class="mode-tab" id="tabJoin">Join</button>
    </div>

    <!-- Create Mode -->
    <div id="createMode" class="mode-content">
      <div style="font-size:11px; color:#555; margin-bottom:10px;">Start a new session and get a Room ID.</div>
      <button id="modalCreateBtn" class="btn-action">Start Session</button>
    </div>

    <!-- Join Mode -->
    <div id="joinMode" class="mode-content hidden">
      <input type="text" id="classIdInput" class="modal-input" placeholder="Room ID (e.g. ORBIT-ABC123)" style="margin-bottom:10px;">
      <button id="modalJoinBtn" class="btn-action">Connect</button>
    </div>

  </div>
</div>

<audio id="tts" autoplay></audio>
<div id="toast" class="toast">Link copied to clipboard</div>

<div class="app-container">
  
  <!-- HEADER -->
  <div class="header">
    <div class="room-info">
      <span class="room-label">Room ID</span>
      <span id="roomIdDisplay" class="room-id">...</span>
    </div>
    
    <!-- SOCIAL SHARE ICONS -->
    <div class="share-row">
      <!-- WhatsApp -->
      <button class="share-btn btn-wa" id="shareWa" title="WhatsApp">
        <svg class="share-icon" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
      </button>
      
      <!-- SMS -->
      <button class="share-btn btn-sms" id="shareSms" title="SMS">
        <svg class="share-icon" viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/>
        </svg>
      </button>

      <!-- Email -->
      <button class="share-btn btn-mail" id="shareMail" title="Email">
        <svg class="share-icon" viewBox="0 0 24 24">
          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
        </svg>
      </button>

      <!-- Messenger -->
      <button class="share-btn btn-fb" id="shareFb" title="Messenger">
        <svg class="share-icon" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.03 2 11c0 2.87 1.5 5.43 3.82 7.03V22l3.37-1.85c.87.24 1.8.38 2.81.38 5.52 0 10-4.03 10-9s-4.48-9-10-9zm1.2 13l-2.43-2.6-4.75 2.6 5.22-5.55 2.43 2.6 4.75-2.6-5.22 5.55z"/>
        </svg>
      </button>

      <button class="share-btn btn-copy" id="copyIdBtn" title="Copy to Clipboard">
        <svg class="share-icon" viewBox="0 0 24 24">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
      
      <button class="share-btn" id="leaveBtn" title="Leave Session" style="background: linear-gradient(145deg, #dc2626, #b91c1c);">
        <svg class="share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
      </button>
    </div>
    
    <!-- Raise Hand Notification Banner -->
    <div id="raiseHandNotification" class="raise-hand-notification">
      <span class="hand-icon">✋</span>
      <span id="raiseHandText"></span>
      <button type="button" class="close-btn" id="closeRaiseHandBtn" title="Dismiss" aria-label="Dismiss notification">✕</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="settings-bar">
    <div class="setting-group">
      <label for="srcLang">I SPEAK</label>
      <select id="srcLang" title="Select your speaking language"></select>
    </div>
    <div class="setting-group">
      <label for="tgtLang">I LISTEN</label>
      <select id="tgtLang" title="Select your listening language"></select>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div id="chatArea" class="chat-area">
    <div style="text-align:center; margin-top:40px; color:#333; font-size:12px; font-style:italic;">
      Translation Active.<br>Unmute to participate.
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="footer">
    <div class="controls-row">
      <!-- Speaker Button -->
      <button id="speakerBtn" class="control-btn speaker-active" type="button" title="Toggle audio playback" aria-label="Toggle speaker">
        <span class="control-btn-icon">
          <svg viewBox="0 0 24 24">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
          </svg>
        </span>
        <span class="btn-visualizer" id="speakerViz">
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
        </span>
        <span>Speaker</span>
        <span class="status-dot"></span>
      </button>

      <!-- Raise Hand Button -->
      <button id="raiseHandBtn" class="raise-hand-btn" type="button" title="Raise Hand" aria-label="Raise Hand">
        ✋
      </button>

      <!-- Mic Button -->
      <button id="micBtn" class="control-btn" type="button" title="Toggle microphone" aria-label="Toggle microphone">
        <span class="control-btn-icon">
          <svg viewBox="0 0 24 24">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </span>
        <span class="btn-visualizer" id="micViz">
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
          <span class="viz-bar"></span>
        </span>
        <span>Mic</span>
        <span class="status-dot"></span>
      </button>
    </div>
  </div>
</div>

<script>
    // --- 1. CONFIGURATION & STATE ---
    const INSTANCE_ID = Math.random().toString(36).substring(2) + Date.now().toString(36);
    let USER_NAME = "Anonymous";
    let CURRENT_ROOM_ID = "";
    
    // Check for room ID in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlRoomId = urlParams.get('room') || urlParams.get('id'); 
    
    // Check for username in URL parameters
    const urlUser = urlParams.get('user') || urlParams.get('username');
    if (urlUser) USER_NAME = urlUser; 
    
    const SUPABASE_URL = "https://xscdwdnjujpkczfhqrgu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzY2R3ZG5qdWpwa2N6Zmhxcmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzEwNjgsImV4cCI6MjA3NjkwNzA2OH0.xuVAkWA5y1oDW_jC52I8JJXF-ovU-5LIBsY9yXzy6cA";
    const CARTESIA_KEY = "sk_car_JmdGRhBt1ocwhqmrxy2gaa";
    const DEEPGRAM_KEY = "52c4137114e2f86597c78326be7b512daae7f266";

    const LANGUAGES = [
      { code: 'af', name: 'Afrikaans' },
      { code: 'sq', name: 'Albanian' },
      { code: 'am', name: 'Amharic' },
      { code: 'ar', name: 'Arabic' },
      { code: 'hy', name: 'Armenian' },
      { code: 'as', name: 'Assamese' },
      { code: 'ay', name: 'Aymara' },
      { code: 'az', name: 'Azerbaijani' },
      { code: 'bm', name: 'Bambara' },
      { code: 'eu', name: 'Basque' },
      { code: 'be', name: 'Belarusian' },
      { code: 'bn', name: 'Bengali' },
      { code: 'bho', name: 'Bhojpuri' },
      { code: 'bs', name: 'Bosnian' },
      { code: 'bg', name: 'Bulgarian' },
      { code: 'ca', name: 'Catalan' },
      { code: 'ceb', name: 'Cebuano' },
      { code: 'ny', name: 'Chichewa' },
      { code: 'zh-CN', name: 'Chinese (Simplified)' },
      { code: 'zh-TW', name: 'Chinese (Traditional)' },
      { code: 'co', name: 'Corsican' },
      { code: 'hr', name: 'Croatian' },
      { code: 'cs', name: 'Czech' },
      { code: 'da', name: 'Danish' },
      { code: 'dv', name: 'Dhivehi' },
      { code: 'doi', name: 'Dogri' },
      { code: 'nl', name: 'Dutch' },
      { code: 'nl', name: 'Dutch (Flemish)' },
      { code: 'en', name: 'English' },
      { code: 'eo', name: 'Esperanto' },
      { code: 'et', name: 'Estonian' },
      { code: 'ee', name: 'Ewe' },
      { code: 'tl', name: 'Filipino (Tagalog)' },
      { code: 'fi', name: 'Finnish' },
      { code: 'fr', name: 'French' },
      { code: 'fy', name: 'Frisian' },
      { code: 'gl', name: 'Galician' },
      { code: 'ka', name: 'Georgian' },
      { code: 'de', name: 'German' },
      { code: 'el', name: 'Greek' },
      { code: 'gn', name: 'Guarani' },
      { code: 'gu', name: 'Gujarati' },
      { code: 'ht', name: 'Haitian Creole' },
      { code: 'ha', name: 'Hausa' },
      { code: 'haw', name: 'Hawaiian' },
      { code: 'he', name: 'Hebrew' },
      { code: 'hi', name: 'Hindi' },
      { code: 'hmn', name: 'Hmong' },
      { code: 'hu', name: 'Hungarian' },
      { code: 'is', name: 'Icelandic' },
      { code: 'ig', name: 'Igbo' },
      { code: 'ilo', name: 'Ilocano' },
      { code: 'id', name: 'Indonesian' },
      { code: 'ga', name: 'Irish' },
      { code: 'it', name: 'Italian' },
      { code: 'ja', name: 'Japanese' },
      { code: 'jw', name: 'Javanese' },
      { code: 'kn', name: 'Kannada' },
      { code: 'kk', name: 'Kazakh' },
      { code: 'km', name: 'Khmer' },
      { code: 'rw', name: 'Kinyarwanda' },
      { code: 'gom', name: 'Konkani' },
      { code: 'ko', name: 'Korean' },
      { code: 'kri', name: 'Krio' },
      { code: 'ku', name: 'Kurdish (Kurmanji)' },
      { code: 'ckb', name: 'Kurdish (Sorani)' },
      { code: 'ky', name: 'Kyrgyz' },
      { code: 'lo', name: 'Lao' },
      { code: 'la', name: 'Latin' },
      { code: 'lv', name: 'Latvian' },
      { code: 'ln', name: 'Lingala' },
      { code: 'lt', name: 'Lithuanian' },
      { code: 'lg', name: 'Luganda' },
      { code: 'lb', name: 'Luxembourgish' },
      { code: 'mk', name: 'Macedonian' },
      { code: 'mai', name: 'Maithili' },
      { code: 'mg', name: 'Malagasy' },
      { code: 'ms', name: 'Malay' },
      { code: 'ml', name: 'Malayalam' },
      { code: 'mt', name: 'Maltese' },
      { code: 'mi', name: 'Maori' },
      { code: 'mr', name: 'Marathi' },
      { code: 'mni-Mtei', name: 'Meiteilon (Manipuri)' },
      { code: 'lus', name: 'Mizo' },
      { code: 'mn', name: 'Mongolian' },
      { code: 'my', name: 'Myanmar (Burmese)' },
      { code: 'ne', name: 'Nepali' },
      { code: 'no', name: 'Norwegian' },
      { code: 'or', name: 'Odia (Oriya)' },
      { code: 'om', name: 'Oromo' },
      { code: 'ps', name: 'Pashto' },
      { code: 'fa', name: 'Persian' },
      { code: 'pl', name: 'Polish' },
      { code: 'pt', name: 'Portuguese' },
      { code: 'pa', name: 'Punjabi' },
      { code: 'qu', name: 'Quechua' },
      { code: 'ro', name: 'Romanian' },
      { code: 'ru', name: 'Russian' },
      { code: 'sm', name: 'Samoan' },
      { code: 'sa', name: 'Sanskrit' },
      { code: 'gd', name: 'Scots Gaelic' },
      { code: 'nso', name: 'Sepedi' },
      { code: 'sr', name: 'Serbian' },
      { code: 'st', name: 'Sesotho' },
      { code: 'sn', name: 'Shona' },
      { code: 'sd', name: 'Sindhi' },
      { code: 'si', name: 'Sinhala' },
      { code: 'sk', name: 'Slovak' },
      { code: 'sl', name: 'Slovenian' },
      { code: 'so', name: 'Somali' },
      { code: 'es', name: 'Spanish' },
      { code: 'su', name: 'Sundanese' },
      { code: 'sw', name: 'Swahili' },
      { code: 'sv', name: 'Swedish' },
      { code: 'tl', name: 'Taglish (Tagalog-English)' },
      { code: 'tg', name: 'Tajik' },
      { code: 'ta', name: 'Tamil' },
      { code: 'tt', name: 'Tatar' },
      { code: 'te', name: 'Telugu' },
      { code: 'th', name: 'Thai' },
      { code: 'ti', name: 'Tigrinya' },
      { code: 'ts', name: 'Tsonga' },
      { code: 'tr', name: 'Turkish' },
      { code: 'tk', name: 'Turkmen' },
      { code: 'ak', name: 'Twi' },
      { code: 'uk', name: 'Ukrainian' },
      { code: 'ur', name: 'Urdu' },
      { code: 'ug', name: 'Uyghur' },
      { code: 'uz', name: 'Uzbek' },
      { code: 'vi', name: 'Vietnamese' },
      { code: 'cy', name: 'Welsh' },
      { code: 'xh', name: 'Xhosa' },
      { code: 'yi', name: 'Yiddish' },
      { code: 'yo', name: 'Yoruba' },
      { code: 'zu', name: 'Zulu' },
      { code: 'byv', name: 'Medumba' } 
    ];

    // --- 3. UI REFERENCES & INIT ---
    const ui = {
        modal: document.getElementById('welcomeModal'),
        username: document.getElementById('usernameInput'),
        classIdInput: document.getElementById('classIdInput'),
        modalJoinBtn: document.getElementById('modalJoinBtn'),
        modalCreateBtn: document.getElementById('modalCreateBtn'),
        tabCreate: document.getElementById('tabCreate'),
        tabJoin: document.getElementById('tabJoin'),
        createMode: document.getElementById('createMode'),
        joinMode: document.getElementById('joinMode'),
        chat: document.getElementById('chatArea'),
        micBtn: document.getElementById('micBtn'),
        speakerBtn: document.getElementById('speakerBtn'),
        micViz: document.getElementById('micViz'),
        speakerViz: document.getElementById('speakerViz'),
        toast: document.getElementById('toast'),
        copyIdBtn: document.getElementById('copyIdBtn'),
        shareWa: document.getElementById('shareWa'),
        shareSms: document.getElementById('shareSms'),
        shareMail: document.getElementById('shareMail'),
        shareFb: document.getElementById('shareFb'),
        srcLang: document.getElementById('srcLang'),
        tgtLang: document.getElementById('tgtLang'),
        raiseHandBtn: document.getElementById('raiseHandBtn'),
        raiseHandNotification: document.getElementById('raiseHandNotification'),
        raiseHandText: document.getElementById('raiseHandText'),
        closeRaiseHandBtn: document.getElementById('closeRaiseHandBtn')
    };

    let speakerOn = true; // Speaker enabled by default
    let raiseHandTimeout = null; // For auto-clearing notification

    // Clear raise hand notification
    function clearRaiseHandNotification() {
        if (raiseHandTimeout) {
            clearTimeout(raiseHandTimeout);
            raiseHandTimeout = null;
        }
        ui.raiseHandNotification.classList.remove('show');
    }

    // Add close button listener
    ui.closeRaiseHandBtn.addEventListener('click', clearRaiseHandNotification);

    // Populate Languages (Sorted)
    function initLangs() {
        LANGUAGES.sort((a, b) => a.name.localeCompare(b.name));
        const opts = LANGUAGES.map(l => `<option value="${l.code}">${l.name}</option>`).join('');
        ui.srcLang.innerHTML = opts;
        ui.tgtLang.innerHTML = opts;
        ui.srcLang.value = "en";
        ui.tgtLang.value = "en"; 
    }
    initLangs();

    // === MODAL TABS LOGIC ===
    ui.tabCreate.addEventListener('click', () => {
        ui.tabCreate.classList.add('active');
        ui.tabJoin.classList.remove('active');
        ui.createMode.classList.remove('hidden');
        ui.joinMode.classList.add('hidden');
    });

    ui.tabJoin.addEventListener('click', () => {
        ui.tabJoin.classList.add('active');
        ui.tabCreate.classList.remove('active');
        ui.joinMode.classList.remove('hidden');
        ui.createMode.classList.add('hidden');
    });

    // 1. Join Existing Logic
    ui.modalJoinBtn.addEventListener('click', () => {
        const name = ui.username.value.trim();
        const enteredId = ui.classIdInput.value.trim().toUpperCase();

        if(!name) return alert("Please enter your Name");
        if(!enteredId) return alert("Please enter a Room ID");

        USER_NAME = name;
        CURRENT_ROOM_ID = enteredId;
        localStorage.setItem('orbit_username', name);
        
        enterSession();
    });

    // 2. Create New Logic
    ui.modalCreateBtn.addEventListener('click', () => {
        const name = ui.username.value.trim();
        if(!name) return alert("Please enter your Name first");

        USER_NAME = name;
        CURRENT_ROOM_ID = 'ORBIT-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        localStorage.setItem('orbit_username', name);
        
        enterSession();
    });

    function enterSession() {
        ui.modal.classList.add('hidden');
        document.getElementById('roomIdDisplay').textContent = CURRENT_ROOM_ID;
        initSupabase();
        
        // Update URL with room ID for easy sharing
        const newUrl = `${window.location.pathname}?room=${CURRENT_ROOM_ID}`;
        window.history.replaceState({}, '', newUrl);
        
        // Save session to localStorage for persistence
        localStorage.setItem('orbit_room_id', CURRENT_ROOM_ID);
        localStorage.setItem('orbit_username', USER_NAME);
        localStorage.setItem('orbit_session_active', 'true');
    }

    // Check for saved session first (persistence on refresh)
    const savedRoomId = localStorage.getItem('orbit_room_id');
    const savedUsername = localStorage.getItem('orbit_username');
    const sessionActive = localStorage.getItem('orbit_session_active');
    
    if (sessionActive === 'true' && savedRoomId && savedUsername) {
        // Auto-rejoin saved session
        USER_NAME = savedUsername;
        CURRENT_ROOM_ID = savedRoomId;
        enterSession();
    } else if (urlRoomId) {
        // Pre-fill from URL parameter
        ui.classIdInput.value = urlRoomId.toUpperCase();
        
        // Switch to Join tab
        ui.tabJoin.classList.add('active');
        ui.tabCreate.classList.remove('active');
        ui.joinMode.classList.remove('hidden');
        ui.createMode.classList.add('hidden');
        
        // Check for saved username
        if (savedUsername) {
            ui.username.value = savedUsername;
        }
    } else if (savedUsername) {
        // Pre-fill username if saved
        ui.username.value = savedUsername;
    }

    // === SHARE FUNCTIONALITY ===
    function getShareUrl() {
        return `${window.location.origin}${window.location.pathname}?room=${CURRENT_ROOM_ID}`;
    }

    function showToast(msg) {
        ui.toast.textContent = msg || "Copied to clipboard";
        ui.toast.classList.add('show');
        setTimeout(() => ui.toast.classList.remove('show'), 2000);
    }

    ui.copyIdBtn.addEventListener('click', () => {
        if(!CURRENT_ROOM_ID) return;
        navigator.clipboard.writeText(getShareUrl());
        showToast("Orbit Link Copied");
    });

    ui.shareWa.addEventListener('click', () => {
        if(!CURRENT_ROOM_ID) return;
        const msg = `Join my Orbit Session: ${getShareUrl()}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    });

    ui.shareSms.addEventListener('click', () => {
        if(!CURRENT_ROOM_ID) return;
        const msg = `Join my Orbit Session: ${getShareUrl()}`;
        window.open(`sms:?&body=${encodeURIComponent(msg)}`, '_blank');
    });

    ui.shareMail.addEventListener('click', () => {
        if(!CURRENT_ROOM_ID) return;
        const msg = `Join my session: ${getShareUrl()}`;
        window.open(`mailto:?subject=Join Orbit Session&body=${encodeURIComponent(msg)}`, '_blank');
    });

    // Leave session - clear persistence and reload
    document.getElementById('leaveBtn').addEventListener('click', () => {
        localStorage.removeItem('orbit_room_id');
        localStorage.removeItem('orbit_session_active');
        // Keep username for convenience
        if (channel) {
            channel.unsubscribe();
        }
        window.location.href = window.location.pathname; // Reload without params
    });

    ui.shareFb.addEventListener('click', () => {
        if(!CURRENT_ROOM_ID) return;
        // Simple Copy fallback for messenger as deep links are flaky on web
        const msg = `Join my Orbit Session: ${CURRENT_ROOM_ID}`;
        navigator.clipboard.writeText(msg);
        showToast("Link Copied (Paste in Messenger)");
        // Try mobile intent
        window.location.href = "fb-messenger://share"; 
    });

    function addMessage(name, text, langCode, isMe = false) {
        if(ui.chat.innerHTML.includes("Translation Active")) ui.chat.innerHTML = "";
        
        const div = document.createElement('div');
        div.className = isMe ? 'msg-item me' : 'msg-item';
        div.innerHTML = `
            <div class="msg-meta">
                <span class="msg-name">${isMe ? 'You' : name}</span>
                <span style="opacity:0.5; font-size:9px;">${langCode.toUpperCase()}</span>
            </div>
            <div class="msg-bubble">${text}</div>
        `;
        ui.chat.appendChild(div);
        ui.chat.scrollTop = ui.chat.scrollHeight;
    }
</script>

<script type="module">
// --- 4. SUPABASE MESH NETWORK ---
let supabase = null;
let channel = null;

window.initSupabase = async function() {
    if(!supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    if(channel) supabase.removeChannel(channel);

    channel = supabase.channel(`room:${CURRENT_ROOM_ID}`);
    
    // Speech messages
    channel.on('broadcast', { event: 'speech' }, async (payload) => {
        const data = payload.payload;
        
        if (data.sender_id === INSTANCE_ID) return;

        const myTargetLang = document.getElementById('tgtLang').value;
        const sourceText = data.text;
        
        let finalText = sourceText;
        
        if (data.lang !== myTargetLang && data.lang !== 'auto') {
             finalText = await window.translateText(sourceText, myTargetLang);
        }

        window.addMessage(data.name, finalText, data.lang);

        if (speakerOn) {
            window.enqueueTTS(finalText);
        }
    });

    // Raise hand event
    channel.on('broadcast', { event: 'raise_hand' }, (payload) => {
        const data = payload.payload;
        if (data.sender_id === INSTANCE_ID) return;
        window.showRaiseHandNotification(data.name);
    });

    channel.subscribe();

    await supabase.auth.signInAnonymously();
};

// Show raise hand notification with 15-second auto-clear
window.showRaiseHandNotification = function(name) {
    const notification = document.getElementById('raiseHandNotification');
    const textEl = document.getElementById('raiseHandText');
    
    // Clear any existing timeout
    if (raiseHandTimeout) {
        clearTimeout(raiseHandTimeout);
    }
    
    textEl.textContent = `${name} Just raised Hands`;
    notification.classList.add('show');
    
    // Auto-clear after 15 seconds
    raiseHandTimeout = setTimeout(() => {
        notification.classList.remove('show');
        raiseHandTimeout = null;
    }, 15000);
};

// Broadcast raise hand
window.broadcastRaiseHand = async function() {
    if(!channel) return;
    
    const btn = document.getElementById('raiseHandBtn');
    btn.classList.add('raised');
    setTimeout(() => btn.classList.remove('raised'), 1000);
    
    await channel.send({
        type: 'broadcast',
        event: 'raise_hand',
        payload: {
            sender_id: INSTANCE_ID,
            name: USER_NAME
        }
    });
    
    // Show own notification too
    window.showRaiseHandNotification(USER_NAME);
};

// Background keep-alive: reconnect when tab becomes visible
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && CURRENT_ROOM_ID) {
        // Reconnect if needed
        if (channel && channel.state !== 'joined') {
            window.initSupabase();
        }
    }
});

// Prevent audio context suspension in background
setInterval(() => {
    // Keep connection alive by sending a heartbeat-like check
    if (channel && channel.state === 'joined') {
        // Connection is healthy
    }
}, 10000);

window.broadcastSpeech = async function(text, lang) {
    if(!channel) return;
    
    await channel.send({
        type: 'broadcast',
        event: 'speech',
        payload: {
            sender_id: INSTANCE_ID,
            name: USER_NAME,
            text: text,
            lang: lang 
        }
    });
    
    window.addMessage("You", text, lang, true); 
};
</script>

<script>
// --- 5. SERVICES & UTILS ---

window.translateText = async function(text, targetCode) {
    let safeTarget = targetCode;
    if(safeTarget === 'byv') safeTarget = 'fr'; 

    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${safeTarget}&dt=t&q=${encodeURIComponent(text)}`;
    try {
        const r = await fetch(url);
        const d = await r.json();
        return d[0].map(x => x[0]).join("");
    } catch (err) { return text; }
};

const ttsAudio = document.getElementById("tts");
let ttsQueue = [];
let isPlaying = false;

window.enqueueTTS = async function(text) {
    try {
        const res = await fetch("https://api.cartesia.ai/tts/bytes", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-API-Key": CARTESIA_KEY, "Cartesia-Version": "2025-04-16" },
            body: JSON.stringify({
                model_id: "sonic-3-latest", transcript: text,
                voice: { mode: "id", id: "9c7e6604-52c6-424a-9f9f-2c4ad89f3bb9" },
                output_format: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 }
            })
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        ttsQueue.push(url);
        processQueue();
    } catch(e) { console.error(e); }
};

function processQueue() {
    if(isPlaying || ttsQueue.length === 0) return;
    isPlaying = true;
    ttsAudio.src = ttsQueue.shift();
    ttsAudio.play();
    ttsAudio.onended = () => { isPlaying = false; processQueue(); };
}

let dgSocket;
let mediaRecorder;
let isMicOn = false;

async function toggleMic() {
    if(isMicOn) {
        isMicOn = false;
        ui.micBtn.classList.remove('mic-active');
        stopMicVisualization();
        if(mediaRecorder) mediaRecorder.stop();
        if(dgSocket) dgSocket.close();
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        isMicOn = true;
        ui.micBtn.classList.add('mic-active');
        startMicVisualization(stream);

        let lang = document.getElementById('srcLang').value;
        if(lang === 'byv') lang = 'fr'; 
        
        dgSocket = new WebSocket(`wss://api.deepgram.com/v1/listen?smart_format=true&model=nova-3&interim_results=true&language=${lang}`, ['token', DEEPGRAM_KEY]);

        dgSocket.onopen = () => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            mediaRecorder.addEventListener('dataavailable', e => {
                if(e.data.size > 0 && dgSocket.readyState === 1) dgSocket.send(e.data);
            });
            mediaRecorder.start(250);
        };

        dgSocket.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            const alt = data.channel?.alternatives[0];
            if(alt && alt.transcript && data.is_final) {
                const txt = alt.transcript.trim();
                if(txt) {
                    window.broadcastSpeech(txt, document.getElementById('srcLang').value);
                }
            }
        };

    } catch(e) {
        console.error(e);
        alert("Microphone access denied.");
    }
}

// Toggle speaker button
function toggleSpeaker() {
    speakerOn = !speakerOn;
    if(speakerOn) {
        ui.speakerBtn.classList.add('speaker-active');
    } else {
        ui.speakerBtn.classList.remove('speaker-active');
    }
}

// Inline Microphone Visualizer
let micAnimationId = null;
let micAnalyser = null;
let micAudioCtx = null;

function startMicVisualization(stream) {
    if(!micAudioCtx) micAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    micAnalyser = micAudioCtx.createAnalyser();
    const src = micAudioCtx.createMediaStreamSource(stream);
    src.connect(micAnalyser);
    micAnalyser.fftSize = 32;
    const bufferLength = micAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const bars = ui.micViz.querySelectorAll('.viz-bar');
    
    function animateBars() {
        if(!isMicOn) return;
        micAnimationId = requestAnimationFrame(animateBars);
        micAnalyser.getByteFrequencyData(dataArray);
        
        bars.forEach((bar, i) => {
            const value = dataArray[i * 2] || dataArray[i];
            const height = Math.max(4, (value / 255) * 20);
            bar.style.height = height + 'px';
            bar.style.opacity = 0.4 + (value / 255) * 0.6;
        });
    }
    animateBars();
}

function stopMicVisualization() {
    if(micAnimationId) cancelAnimationFrame(micAnimationId);
    const bars = ui.micViz.querySelectorAll('.viz-bar');
    bars.forEach(bar => {
        bar.style.height = '4px';
        bar.style.opacity = '0.6';
    });
}

ui.micBtn.addEventListener('click', toggleMic);
ui.speakerBtn.addEventListener('click', toggleSpeaker);
ui.raiseHandBtn.addEventListener('click', () => window.broadcastRaiseHand());
</script>
</body>
</html>
